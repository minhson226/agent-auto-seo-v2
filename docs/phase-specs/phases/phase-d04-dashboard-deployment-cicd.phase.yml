phase:
  id: "PHASE-D04"
  slug: "dashboard-deployment-cicd"
  title: "Dashboard - Docker, Deployment & CI/CD Integration"

  summary: |
    Containerize the admin dashboard for production deployment, integrate it with the existing
    Docker Compose setup, update the CI/CD pipeline to build and test the dashboard, configure
    Nginx for optimal serving, and update all deployment documentation. This phase makes the
    dashboard production-ready and fully integrated into the deployment workflow.

  goal: |
    A production-ready, containerized dashboard that can be deployed alongside backend services,
    with automated CI/CD pipeline for building, testing, and deploying, complete with health
    checks, monitoring, and comprehensive deployment documentation.

  from_master_spec:
    sections:
      - "master-spec-dashboard-api.txt - Section 4: Docker & Deployment"
      - "master-spec-dashboard-api.txt - Section 5: CI/CD Integration"
      - "master-spec-dashboard-api.txt - Section 6: Documentation Requirements"

  scope:
    included:
      - "Create production Dockerfile for dashboard (multi-stage build)"
      - "Configure Nginx for serving SPA and proxying API requests"
      - "Add dashboard service to docker-compose.prod.yml"
      - "Configure environment variables for production"
      - "Implement health check endpoint"
      - "Update CI/CD pipeline (.github/workflows/ci-cd.yml)"
      - "Add dashboard build step to CI/CD"
      - "Add dashboard test step to CI/CD"
      - "Add dashboard Docker build and push to CI/CD"
      - "Add dashboard deployment step to CI/CD"
      - "Create .env.production.example for dashboard"
      - "Update docs/deployment/production-guide.md"
      - "Update docs/setup/local-development.md"
      - "Update docs/api/README.md with dashboard context"
      - "Create frontend/dashboard/README.md with complete setup guide"
      - "Add smoke tests for post-deployment validation"
    excluded:
      - "Kubernetes deployment (can be added later)"
      - "CDN configuration"
      - "Advanced caching strategies"
      - "Load testing"
      - "Monitoring dashboards (Grafana, etc.)"

  dependencies:
    - "PHASE-D03"

  inputs:
    - name: "Complete Dashboard"
      type: "codebase"
      location: "frontend/dashboard/"
      description: "Fully functional dashboard from PHASE-D02 and PHASE-D03"
    - name: "Docker Compose Production Config"
      type: "config"
      location: "docker-compose.prod.yml"
      description: "Existing production deployment configuration"
    - name: "CI/CD Pipeline"
      type: "config"
      location: ".github/workflows/ci-cd.yml"
      description: "Existing CI/CD workflow"
    - name: "Deployment Documentation"
      type: "documentation"
      location: "docs/deployment/"
      description: "Current deployment guides"

  outputs:
    - name: "Dashboard Dockerfile"
      type: "config"
      description: "Production-optimized multi-stage Dockerfile"
      location_hint: "frontend/dashboard/Dockerfile"
    - name: "Nginx Configuration"
      type: "config"
      description: "Nginx config for SPA and API proxy"
      location_hint: "frontend/dashboard/nginx.conf"
    - name: "Updated Docker Compose"
      type: "config"
      description: "Production compose with dashboard service"
      location_hint: "docker-compose.prod.yml"
    - name: "Updated CI/CD Pipeline"
      type: "config"
      description: "CI/CD with dashboard build/test/deploy"
      location_hint: ".github/workflows/ci-cd.yml"
    - name: "Environment Configuration"
      type: "config"
      description: "Environment variable templates"
      location_hint: "frontend/dashboard/.env.production.example"
    - name: "Deployment Documentation"
      type: "documentation"
      description: "Updated deployment guides"
      location_hint: "docs/deployment/, docs/setup/, frontend/dashboard/README.md"

  implementation_prompt: |
    You are a senior DevOps engineer implementing **PHASE-D04: Dashboard - Docker, Deployment & CI/CD Integration** for the Auto-SEO platform.

    ## CONTEXT

    The admin dashboard is now fully functional with all features implemented
    (PHASE-D02 and PHASE-D03). Your task is to make it production-ready by
    containerizing it, integrating with existing deployment infrastructure,
    and automating the build/test/deploy pipeline.

    **Current State:**
    - Complete dashboard in frontend/dashboard/
    - Backend services containerized and deployed
    - CI/CD pipeline exists for backend services
    - docker-compose.prod.yml exists but lacks dashboard

    **Target State:**
    - Dashboard containerized with optimized Dockerfile
    - Dashboard integrated into docker-compose.prod.yml
    - CI/CD pipeline builds, tests, and deploys dashboard
    - Complete deployment documentation
    - Production-ready configuration

    ## DELIVERABLES

    ### 1. Production Dockerfile

    **Create `frontend/dashboard/Dockerfile`:**

    ```dockerfile
    # Multi-stage build for optimized production image

    # Stage 1: Build
    FROM node:20-alpine AS builder

    WORKDIR /app

    # Copy package files
    COPY package.json package-lock.json ./

    # Install dependencies
    RUN npm ci --only=production=false

    # Copy source code
    COPY . .

    # Build for production
    ARG VITE_API_URL
    ENV VITE_API_URL=${VITE_API_URL}
    RUN npm run build

    # Stage 2: Production
    FROM nginx:1.25-alpine

    # Copy custom nginx config
    COPY nginx.conf /etc/nginx/nginx.conf

    # Copy built assets from builder
    COPY --from=builder /app/dist /usr/share/nginx/html

    # Add health check script
    COPY healthcheck.sh /healthcheck.sh
    RUN chmod +x /healthcheck.sh

    # Expose port
    EXPOSE 80

    # Health check
    HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
      CMD /healthcheck.sh

    # Start nginx
    CMD ["nginx", "-g", "daemon off;"]
    ```

    ### 2. Nginx Configuration

    **Create `frontend/dashboard/nginx.conf`:**

    ```nginx
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript
                   application/x-javascript application/xml+rss
                   application/javascript application/json;

        server {
            listen 80;
            server_name _;
            root /usr/share/nginx/html;
            index index.html;

            # Security headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "no-referrer-when-downgrade" always;
            add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }

            # Cache HTML files for 5 minutes
            location ~* \.html$ {
                expires 5m;
                add_header Cache-Control "public, must-revalidate";
            }

            # Health check endpoint
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }

            # API proxy (optional - if API and dashboard on same domain)
            location /api/ {
                proxy_pass http://api-gateway:8000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
            }

            # SPA fallback - serve index.html for all routes
            location / {
                try_files $uri $uri/ /index.html;
            }
        }
    }
    ```

    ### 3. Health Check Script

    **Create `frontend/dashboard/healthcheck.sh`:**

    ```bash
    #!/bin/sh
    # Health check script for dashboard container

    # Check if nginx is running
    if ! pgrep nginx > /dev/null; then
        echo "Nginx is not running"
        exit 1
    fi

    # Check if we can curl the health endpoint
    if ! wget --quiet --tries=1 --spider http://localhost/health; then
        echo "Health endpoint not responding"
        exit 1
    fi

    echo "Dashboard is healthy"
    exit 0
    ```

    ### 4. Environment Configuration

    **Create `frontend/dashboard/.env.production.example`:**

    ```env
    # API Gateway URL
    VITE_API_URL=http://api-gateway:8000

    # App Configuration
    VITE_APP_NAME=Auto-SEO Admin Dashboard
    VITE_APP_VERSION=1.0.0

    # Feature Flags (optional)
    VITE_ENABLE_ANALYTICS=true
    VITE_ENABLE_NOTIFICATIONS=true

    # External Services (if any)
    # VITE_GOOGLE_ANALYTICS_ID=
    # VITE_SENTRY_DSN=
    ```

    ### 5. Update Docker Compose Production

    **Update `docker-compose.prod.yml`:**

    ```yaml
    # Add to services section:

      # Admin Dashboard
      dashboard:
        build:
          context: ./frontend/dashboard
          dockerfile: Dockerfile
          args:
            VITE_API_URL: ${DASHBOARD_API_URL:-http://localhost:9101}
        container_name: autoseo-dashboard
        restart: unless-stopped
        ports:
          - "9102:80"  # Map to host port 9102
        depends_on:
          api-gateway:
            condition: service_healthy
        healthcheck:
          test: ["CMD", "/healthcheck.sh"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 40s
        networks:
          - autoseo-network
        labels:
          - "com.autoseo.service=dashboard"
          - "com.autoseo.version=1.0.0"
        logging:
          driver: "json-file"
          options:
            max-size: "10m"
            max-file: "3"
    ```

    ### 6. Update CI/CD Pipeline

    **Update `.github/workflows/ci-cd.yml`:**

    Add dashboard-specific jobs:

    ```yaml
    jobs:
      # ... existing jobs ...

      # Dashboard Build & Test
      dashboard-build-test:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '20'
              cache: 'npm'
              cache-dependency-path: frontend/dashboard/package-lock.json

          - name: Install dependencies
            working-directory: frontend/dashboard
            run: npm ci

          - name: Run linter
            working-directory: frontend/dashboard
            run: npm run lint

          - name: Run tests
            working-directory: frontend/dashboard
            run: npm run test

          - name: Build dashboard
            working-directory: frontend/dashboard
            env:
              VITE_API_URL: ${{ secrets.VITE_API_URL }}
            run: npm run build

          - name: Upload build artifacts
            uses: actions/upload-artifact@v4
            with:
              name: dashboard-build
              path: frontend/dashboard/dist

      # Dashboard Docker Build & Push
      dashboard-docker:
        needs: dashboard-build-test
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3

          - name: Login to Container Registry
            uses: docker/login-action@v3
            with:
              registry: ${{ secrets.REGISTRY_URL }}
              username: ${{ secrets.REGISTRY_USERNAME }}
              password: ${{ secrets.REGISTRY_PASSWORD }}

          - name: Build and push dashboard image
            uses: docker/build-push-action@v5
            with:
              context: ./frontend/dashboard
              file: ./frontend/dashboard/Dockerfile
              push: true
              tags: |
                ${{ secrets.REGISTRY_URL }}/autoseo-dashboard:latest
                ${{ secrets.REGISTRY_URL }}/autoseo-dashboard:${{ github.sha }}
              build-args: |
                VITE_API_URL=${{ secrets.VITE_API_URL }}
              cache-from: type=registry,ref=${{ secrets.REGISTRY_URL }}/autoseo-dashboard:buildcache
              cache-to: type=registry,ref=${{ secrets.REGISTRY_URL }}/autoseo-dashboard:buildcache,mode=max

      # Deploy Dashboard
      deploy-dashboard:
        needs: dashboard-docker
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
          - name: Deploy to production server
            uses: appleboy/ssh-action@v1.0.0
            with:
              host: ${{ secrets.PROD_SERVER_HOST }}
              username: ${{ secrets.PROD_SERVER_USER }}
              key: ${{ secrets.PROD_SERVER_SSH_KEY }}
              script: |
                cd /srv/apps/auto-seo
                docker-compose pull dashboard
                docker-compose up -d dashboard
                docker-compose ps

          - name: Health check
            run: |
              sleep 10
              curl -f http://${{ secrets.PROD_SERVER_HOST }}:9102/health || exit 1

          - name: Notify deployment
            if: success()
            run: echo "Dashboard deployed successfully!"
    ```

    ### 7. Update Documentation

    **Update `docs/deployment/production-guide.md`:**

    Add section:

    ```markdown
    ## Dashboard Deployment

    ### Prerequisites
    - Docker and Docker Compose installed
    - Port 9102 available on host

    ### Environment Variables

    Create `.env.production` with:
    ```
    DASHBOARD_API_URL=http://your-api-gateway-url:9101
    ```

    ### Build and Deploy

    ```bash
    # Build dashboard image
    docker-compose -f docker-compose.prod.yml build dashboard

    # Start dashboard
    docker-compose -f docker-compose.prod.yml up -d dashboard

    # Check health
    curl http://localhost:9102/health
    ```

    ### Access Dashboard

    Open browser to: http://your-server:9102

    Default login credentials are set during auth-service initial setup.

    ### Troubleshooting

    **Dashboard not loading:**
    - Check logs: `docker logs autoseo-dashboard`
    - Verify API_URL is correct
    - Check network connectivity to api-gateway

    **API requests failing:**
    - Verify api-gateway is healthy
    - Check CORS configuration
    - Review network settings in docker-compose
    ```

    **Update `docs/setup/local-development.md`:**

    Add section:

    ```markdown
    ## Dashboard Development

    ### Setup

    ```bash
    cd frontend/dashboard
    npm install
    ```

    ### Environment Configuration

    Create `.env.local`:
    ```
    VITE_API_URL=http://localhost:8000
    ```

    ### Run Development Server

    ```bash
    npm run dev
    ```

    Dashboard will be available at: http://localhost:5173

    ### Build for Production

    ```bash
    npm run build
    npm run preview  # Preview production build
    ```

    ### Run Tests

    ```bash
    npm run test        # Run once
    npm run test:watch  # Watch mode
    ```

    ### Linting

    ```bash
    npm run lint
    ```
    ```

    **Create `frontend/dashboard/README.md`:**

    ```markdown
    # Auto-SEO Admin Dashboard

    React-based admin dashboard for the Auto-SEO platform.

    ## Features

    - üîê Authentication & Authorization
    - üìä Analytics & Performance Metrics
    - üìù Content Management (Keywords, Articles, Plans)
    - üéØ Topic Clustering (Drag & Drop)
    - ‚úÖ SEO Scoring & Recommendations
    - üöÄ WordPress Publishing
    - üîî Notifications
    - ‚öôÔ∏è System Monitoring

    ## Tech Stack

    - React 19
    - TypeScript
    - Vite
    - TailwindCSS
    - React Query
    - React Router
    - Recharts
    - React DnD

    ## Getting Started

    See [Local Development Guide](../../docs/setup/local-development.md#dashboard-development)

    ## Project Structure

    ```
    src/
    ‚îú‚îÄ‚îÄ api/          # API client
    ‚îú‚îÄ‚îÄ components/   # React components
    ‚îú‚îÄ‚îÄ hooks/        # Custom hooks
    ‚îú‚îÄ‚îÄ pages/        # Page components
    ‚îú‚îÄ‚îÄ store/        # State management
    ‚îú‚îÄ‚îÄ types/        # TypeScript types
    ‚îî‚îÄ‚îÄ utils/        # Utilities
    ```

    ## Available Scripts

    - `npm run dev` - Start development server
    - `npm run build` - Build for production
    - `npm run preview` - Preview production build
    - `npm run test` - Run tests
    - `npm run lint` - Lint code

    ## Environment Variables

    See `.env.production.example` for all available variables.

    ## Deployment

    See [Production Deployment Guide](../../docs/deployment/production-guide.md#dashboard-deployment)

    ## License

    Proprietary - Auto-SEO Platform
    ```

    ### 8. Add .dockerignore

    **Create `frontend/dashboard/.dockerignore`:**

    ```
    node_modules
    dist
    .env
    .env.local
    .env.development
    .git
    .gitignore
    README.md
    npm-debug.log
    .vscode
    .idea
    *.test.ts
    *.test.tsx
    coverage
    .DS_Store
    ```

    ## TESTING & VALIDATION

    ### Local Testing

    ```bash
    # Build Docker image
    cd frontend/dashboard
    docker build -t autoseo-dashboard:test .

    # Run container
    docker run -d -p 9102:80 --name dashboard-test autoseo-dashboard:test

    # Test health check
    curl http://localhost:9102/health

    # Test dashboard
    open http://localhost:9102

    # Check logs
    docker logs dashboard-test

    # Cleanup
    docker stop dashboard-test
    docker rm dashboard-test
    ```

    ### Integration Testing

    ```bash
    # Start full stack
    docker-compose -f docker-compose.prod.yml up -d

    # Wait for services
    sleep 30

    # Smoke test
    curl -f http://localhost:9102/health
    curl -f http://localhost:9101/api/v1/health

    # Check dashboard loads
    curl -f http://localhost:9102 | grep "Auto-SEO"
    ```

    ## ACCEPTANCE CRITERIA

    - [ ] Dockerfile builds successfully
    - [ ] Docker image size optimized (<100MB for final stage)
    - [ ] Nginx serves static files correctly
    - [ ] SPA routing works (all routes serve index.html)
    - [ ] Health check endpoint responds
    - [ ] Dashboard service in docker-compose.prod.yml
    - [ ] Environment variables configurable
    - [ ] CI/CD pipeline builds dashboard
    - [ ] CI/CD pipeline runs tests
    - [ ] CI/CD pipeline builds and pushes Docker image
    - [ ] CI/CD pipeline deploys dashboard
    - [ ] Health check passes after deployment
    - [ ] Documentation complete and accurate
    - [ ] Dashboard accessible in production
    - [ ] API requests work from dashboard
    - [ ] No console errors in production build

    ## DELIVERABLES CHECKLIST

    - [ ] frontend/dashboard/Dockerfile
    - [ ] frontend/dashboard/nginx.conf
    - [ ] frontend/dashboard/healthcheck.sh
    - [ ] frontend/dashboard/.env.production.example
    - [ ] frontend/dashboard/.dockerignore
    - [ ] frontend/dashboard/README.md
    - [ ] docker-compose.prod.yml (updated)
    - [ ] .github/workflows/ci-cd.yml (updated)
    - [ ] docs/deployment/production-guide.md (updated)
    - [ ] docs/setup/local-development.md (updated)
    - [ ] All documentation reviewed and accurate

    Good luck with the deployment! Make it production-ready and robust.

  acceptance_criteria:
    - "Dockerfile builds successfully with multi-stage build"
    - "Final Docker image size is optimized (<100MB)"
    - "Nginx configuration serves SPA correctly"
    - "All routes in SPA work (fallback to index.html)"
    - "Health check endpoint returns 200 OK"
    - "Health check script works correctly"
    - "Dashboard service added to docker-compose.prod.yml"
    - "Dashboard container starts successfully"
    - "Dashboard container passes health checks"
    - "Environment variables work correctly"
    - "API proxy configuration works (if enabled)"
    - "Static assets served with correct cache headers"
    - "Gzip compression enabled"
    - "Security headers configured"
    - "CI/CD pipeline includes dashboard build job"
    - "CI/CD pipeline runs linter on dashboard code"
    - "CI/CD pipeline runs tests on dashboard"
    - "CI/CD pipeline builds Docker image"
    - "CI/CD pipeline pushes image to registry"
    - "CI/CD pipeline deploys to production"
    - "Post-deployment health check passes"
    - "docs/deployment/production-guide.md updated with dashboard section"
    - "docs/setup/local-development.md updated with dashboard dev instructions"
    - "frontend/dashboard/README.md created with complete guide"
    - "All documentation accurate and complete"
    - "Dashboard accessible at configured port in production"
    - "Dashboard can communicate with API Gateway"
    - "No 404 errors for static assets"
    - "No console errors in production build"
    - "HTTPS works if configured (with proper cert)"

  non_goals:
    - "Kubernetes deployment configuration"
    - "CDN setup (CloudFront, Cloudflare)"
    - "Advanced caching with Redis/Varnish"
    - "Load testing or performance benchmarking"
    - "Monitoring dashboards (Grafana)"
    - "Log aggregation (ELK stack)"
    - "SSL certificate management (Let's Encrypt automation)"
    - "Multi-region deployment"
    - "Blue-green deployment strategy"
    - "Rollback automation"

  notes:
    - "This phase focuses on containerization and basic deployment"
    - "Advanced deployment strategies (K8s, CDN) can be added later"
    - "Ensure Docker image is optimized for size and security"
    - "Use multi-stage build to keep final image small"
    - "nginx.conf should be tested thoroughly"
    - "Health checks are critical for production reliability"
    - "CI/CD should fail fast if tests don't pass"
    - "Document any manual deployment steps clearly"
    - "Include rollback procedure in documentation"
    - "Test the entire deployment pipeline before merging"
    - "Consider adding deployment notifications (Slack, email)"
    - "Make sure secrets are never committed to git"
    - "Use GitHub Secrets for sensitive CI/CD variables"
