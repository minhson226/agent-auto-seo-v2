name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'release/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      deploy_to_production:
        description: 'Deploy to production environment'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose
        run: docker compose config -q

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Validate Kubernetes manifests
        run: |
          echo "Validating Kubernetes manifests..."
          for file in $(find k8s -name "*.yaml" -o -name "*.yml"); do
            echo "Validating $file"
            kubectl apply --dry-run=client -f "$file" || true
          done

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_data: |
            extends: relaxed
            rules:
              line-length:
                max: 200
              truthy:
                check-keys: false

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: lint-and-validate
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push API Gateway
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./services/api-gateway
          file: ./services/api-gateway/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Auth Service
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./services/auth-service
          file: ./services/auth-service/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Notification Service
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./services/notification-service
          file: ./services/notification-service/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notification-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notification-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Content Generator
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./services/content-generator
          file: ./services/content-generator/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/content-generator:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/content-generator:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Analytics Service
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./services/analytics
          file: ./services/analytics/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/analytics:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/analytics:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Dashboard Frontend
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/dashboard
          file: ./frontend/dashboard/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/dashboard:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/dashboard:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build summary
        run: |
          echo "‚úÖ Docker images built and pushed successfully"
          echo "Image tag: ${{ steps.meta.outputs.version }}"
          echo "Registry: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

  test-infrastructure:
    name: Test Infrastructure
    runs-on: ubuntu-latest
    needs: lint-and-validate
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start infrastructure
        run: |
          docker compose up -d postgres redis
          sleep 30

      - name: Test PostgreSQL connection
        run: |
          docker compose exec -T postgres pg_isready -U autoseo

      - name: Test Redis connection
        run: |
          docker compose exec -T redis redis-cli -a redis_secret ping

      - name: Cleanup
        if: always()
        run: docker compose down -v

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-images, test-infrastructure]
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_production == 'true')
    environment: production
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy info
        run: |
          echo "üöÄ Deploying to Production"
          echo "Commit: ${{ github.sha }}"
          echo "Image tag: ${{ needs.build-images.outputs.image_tag }}"
          echo "Target: ${{ secrets.PROD_SSH_HOST }}:9101"
          echo "Path: /srv/apps/auto-seo"

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          timeout: '60s'          # th·ªùi gian cho SSH handshake
          command_timeout: '45m'  # cho ph√©p docker compose pull + up ch·∫°y l√¢u
          script: |
            set -e
            echo "üìÅ Navigating to application directory"
            cd /srv/apps/auto-seo

            echo "üì• Pulling latest code from main"
            git fetch origin main
            git checkout main
            git pull origin main

            echo "üè∑Ô∏è Setting image tag"
            export IMAGE_TAG="${{ needs.build-images.outputs.image_tag }}"

            # Update or add IMAGE_TAG to .env file
            if grep -q "^IMAGE_TAG=" .env 2>/dev/null; then
              sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=${IMAGE_TAG}/" .env
            else
              echo "IMAGE_TAG=${IMAGE_TAG}" >> .env
            fi

            echo "üê≥ Pulling Docker images (prod)"
            docker compose -f docker-compose.prod.yml pull

            echo "üîÑ Restarting services (prod)"
            docker compose -f docker-compose.prod.yml up -d

            echo "‚è≥ Waiting for services to stabilize (30s)"
            sleep 30

            echo "‚úÖ Deployment complete"
            docker compose -f docker-compose.prod.yml ps

      - name: Health Check
        run: |
          echo "üè• Running health checks"

          MAX_RETRIES=10
          RETRY_DELAY=5

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Checking health endpoint..."

            RESPONSE=$(curl -s -w "\n%{http_code}" http://${{ secrets.PROD_SSH_HOST }}:9101/health || echo "000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)

            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "‚è≥ Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Post-deploy diagnostics (on failure)
        if: failure()
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          timeout: '60s'
          command_timeout: '15m'
          script: |
            echo "üîç Gathering diagnostic information"
            cd /srv/apps/auto-seo

            echo "=== Docker Compose Status ==="
            docker compose -f docker-compose.prod.yml ps

            echo "=== API Gateway Logs (last 100 lines) ==="
            docker compose -f docker-compose.prod.yml logs --tail=100 api-gateway

            echo "=== Container Health ==="
            docker ps --filter "name=autoseo-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
